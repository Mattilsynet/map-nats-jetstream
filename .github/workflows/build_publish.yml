name: build_push

on:
  push:
    branches:
      - master
      
jobs:
  wash-build:
    runs-on: ubuntu-latest
    env:
      built_file_name: map-nats-jetstream.par.gz
    permissions:
     contents: 'write'
     packages: 'write'
    steps:
     - name: checkout
       uses: actions/checkout@v4
     - name: install go
       uses: actions/setup-go@v5
     - name: install wash-cli cached
       uses: taiki-e/cache-cargo-install-action@v2
       with:
         tool: wash-cli
     - name: generate go files
       shell: bash
       run: |
          go generate ./...
     - name: validate-yaml
       shell: bash
       run: |
          [[ ! -f wadm.yaml ]] || wash app validate wadm.yaml
          [[ ! -f local.wadm.yaml ]] || wash app validate local.wadm.yaml
     - name: wash build
       shell: bash
       run: |
         wash build
     - name: publish package to github repository 
       env:
         WASH_REG_USER: ${{ github.repository_owner }}
         WASH_REG_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
       shell: bash
       run: |
          wash push ghcr.io/${{ github.repository }}:${{ github.ref_name }} ${{ env.built_file_name }} --annotation org.opencontainers.image.source=${{github.server_url}}/${{ github.repository }}
       working-directory: build


#TODO: run wash up, wash apply and check output for success messages
      
 
